# 📊 サンプル1：リアルタイム株価シミュレータ

## 概要

株式市場のリアルタイム価格変動をシミュレートし、MQTT経由で配信・監視するシステムです。複数の銘柄（AAPL、GOOGL、TSLA）の価格が変動する様子をリアルタイムで観察できます。

## 動作説明

### システムの動作フロー

```
┌─────────────────────┐         ┌─────────────────┐         ┌─────────────────────┐
│  stock_publisher.py │         │  MQTT Broker    │         │  stock_monitor.py   │
│  (価格データ生成)   │────────>│  (localhost)    │────────>│  (価格表示)         │
└─────────────────────┘         └─────────────────┘         └─────────────────────┘
         │                                                              │
         │ 2秒ごとに                                                    │
         │ ・AAPL: $150.0 → $151.2                                     │ 💰 AAPL: $151.20
         │ ・GOOGL: $2800.0 → $2795.3                                  │ 💰 GOOGL: $2,795.30
         │ ・TSLA: $700.0 → $703.4                                     │ 💰 TSLA: $703.40
         └─────────────────────────────────────────────────────────────┘
                      Pub/Subパターンで非同期通信
```

### Publisher（stock_publisher.py）の動作

1. **初期価格の設定**: 3銘柄の開始価格を定義
   - AAPL: $150.0
   - GOOGL: $2,800.0
   - TSLA: $700.0

2. **価格変動のシミュレーション**:
   - 2秒ごとに各銘柄の価格を更新
   - ランダムに-2%〜+2%の範囲で変動
   - リアルな市場の動きを模擬

3. **MQTTトピックへの配信**:
   - `stock/AAPL` - Apple株価
   - `stock/GOOGL` - Google株価
   - `stock/TSLA` - Tesla株価

### Monitor（stock_monitor.py）の動作

1. **ワイルドカードサブスクライブ**: `stock/#` で全銘柄を監視
2. **リアルタイム表示**: 価格更新を即座に画面に表示
3. **書式設定**: カンマ区切りで見やすく表示（例: $2,795.30）

## 技術的なポイント

### 1. MQTT Pub/Subパターンの実装

**Publisher側**:
```python
client = mqtt.Client()
client.connect(BROKER, 1883, 60)

# トピックにメッセージを送信
client.publish(f"stock/{symbol}", message)
```

**Subscriber側**:
```python
def on_connect(client, userdata, flags, rc):
    # ワイルドカード(#)で全サブトピックを購読
    client.subscribe("stock/#")

def on_message(client, userdata, msg):
    # トピック名から銘柄名を抽出
    symbol = msg.topic.split('/')[1]  # "stock/AAPL" → "AAPL"
    price = float(msg.payload.decode())
```

### 2. MQTTトピック階層の活用

```
stock/              ← ベーストピック
  ├─ AAPL           ← 個別銘柄
  ├─ GOOGL
  └─ TSLA
```

- **ワイルドカード `#`**: すべてのサブトピックにマッチ
- **柔軟な拡張性**: 新しい銘柄を追加しても、Monitor側のコード変更不要

### 3. 非同期通信の利点

- **疎結合**: PublisherとSubscriberは互いの存在を知らない
- **スケーラビリティ**: 複数のMonitorが同時に接続可能
- **耐障害性**: 一方が停止しても他方は影響を受けない

### 4. データ形式の設計

**シンプルな文字列形式**:
- Payload: `"151.20"` （価格のみ）
- メタデータ: トピック名に含める（`stock/AAPL`）

**利点**:
- 軽量で高速
- 帯域幅の節約
- パース処理が簡単

### 5. 価格変動アルゴリズム

```python
change = random.uniform(-0.02, 0.02)  # -2%〜+2%
new_price = round(price * (1 + change), 2)  # 小数点以下2桁
```

- **現実的な変動**: 前回価格からの相対変化
- **精度管理**: round()で小数点制御
- **累積変動**: 価格は継続的に変化

## 設計・実装のポイント

### アーキテクチャ上の工夫

1. **トピック設計の重要性**
   - 階層構造により、カテゴリ別の購読が可能
   - 将来的な拡張を見越した設計（例: `stock/us/AAPL`, `stock/jp/SONY`）

2. **状態管理**
   - Publisher側で価格の状態を保持
   - 各更新は前回値に基づいて計算

3. **エラーハンドリング**
   - `KeyboardInterrupt`で安全に終了
   - 接続切断時の適切なクリーンアップ

### パフォーマンス考慮

- **更新頻度**: 2秒間隔でネットワーク負荷を抑制
- **QoS 0（デフォルト）**: 配信保証なしで最大スループット
- **軽量ペイロード**: 数値のみで帯域を節約

### 拡張可能性

現在の設計では、以下のような拡張が容易です:

```python
# 拡張例1: 銘柄の追加
stocks = {
    "AAPL": 150.0,
    "GOOGL": 2800.0,
    "TSLA": 700.0,
    "MSFT": 300.0,  # 追加
    "AMZN": 3000.0  # 追加
}

# 拡張例2: より詳細なデータ
data = {
    "price": 150.0,
    "volume": 1000000,
    "change": 1.5
}
client.publish(f"stock/{symbol}", json.dumps(data))
```

## 使用方法

### 前提条件

- MQTTブローカー（Mosquitto）が起動していること
- paho-mqttライブラリがインストール済みであること

### 実行手順

1. **ターミナル1でMonitorを起動**:
   ```bash
   cd mqtt_clients/samples/01_stock_simulator
   python stock_monitor.py
   ```

   期待される出力:
   ```
   📡 株価モニター開始
   ```

2. **ターミナル2でPublisherを起動**:
   ```bash
   cd mqtt_clients/samples/01_stock_simulator
   python stock_publisher.py
   ```

   期待される出力:
   ```
   📈 株価シミュレータを開始...
   --------------------------------------------------
   📊 AAPL: $150.5
   📊 GOOGL: $2810.3
   📊 TSLA: $695.8
   --------------------------------------------------
   ```

3. **Monitor側で価格の受信を確認**:
   ```
   💰 AAPL: $150.50
   💰 GOOGL: $2,810.30
   💰 TSLA: $695.80
   ```

4. **終了**: 両方のターミナルで`Ctrl+C`

## 学習ポイント

### 初級レベル

- ✅ **基本的なPub/Sub**: PublisherとSubscriberの役割
- ✅ **トピックの概念**: メッセージのルーティング方法
- ✅ **ワイルドカード**: `#`による一括購読

### 中級レベル

- ✅ **トピック階層設計**: スケーラブルな構造
- ✅ **非同期処理**: loop_forever()の仕組み
- ✅ **コールバック関数**: on_connect、on_messageの使い方

### 上級レベル

- ✅ **システム設計**: 疎結合なアーキテクチャ
- ✅ **データモデリング**: トピックとペイロードの分離
- ✅ **パフォーマンス最適化**: 更新頻度とデータサイズのバランス

## 応用アイデア

1. **履歴データの保存**: データベースに価格履歴を蓄積
2. **アラート機能**: 価格が閾値を超えたら通知
3. **チャート表示**: matplotlibでリアルタイムグラフ
4. **取引シミュレーション**: 売買ロジックの実装
5. **マルチマーケット対応**: 株式、FX、仮想通貨など

## トラブルシューティング

### よくある問題

1. **接続エラー**:
   - Mosquittoブローカーが起動しているか確認
   - ポート1883が利用可能か確認

2. **メッセージが届かない**:
   - Publisher側でエラーが出ていないか確認
   - トピック名が正確に一致しているか確認

3. **価格表示が文字化け**:
   - UTF-8エンコーディングが正しいか確認
   - ターミナルの文字コード設定を確認

## まとめ

このサンプルでは、MQTTの基本的なPub/Subパターンと、実用的なトピック階層設計を学べます。シンプルながら、実際の金融データ配信システムと同じアーキテクチャを採用しており、スケーラブルで拡張性の高い設計となっています。
