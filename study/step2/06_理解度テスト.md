# 第2章 理解度確認テスト
## DockerでMQTT Brokerを構築

## 📋 テスト問題（全10問）

このテストは、第2章で学んだDockerとMosquittoの知識を確認するためのものです。
各問題に答えてから、下の解答セクションで確認してください。

---

### 問題1：Dockerコマンドの理解（選択式）

以下のDockerコマンドで、`-d` オプションの意味は何ですか？

```bash
docker run -d --name mqtt-broker -p 1883:1883 eclipse-mosquitto
```

A) デバッグモードで起動する
B) バックグラウンドで起動する（デタッチモード）
C) データディレクトリを指定する
D) 削除可能なコンテナとして起動する

---

### 問題2：ポートマッピング（記述式）

以下のコマンドを実行した場合、MQTTクライアントはどのホスト名とポート番号で接続すればよいですか？

```bash
docker run -d --name mqtt-broker -p 1884:1883 eclipse-mosquitto
```

**回答欄**:
- ホスト名: ____________
- ポート番号: ____________

---

### 問題3：ボリュームマウント（マッチング）

以下のボリュームマウントの役割を正しく結び付けてください。

```bash
docker run -d \
  -v ./mqtt/config:/mosquitto/config \   # 1
  -v ./mqtt/data:/mosquitto/data \       # 2
  -v ./mqtt/log:/mosquitto/log \         # 3
  eclipse-mosquitto
```

A) ログファイルの保存先
B) 設定ファイル（mosquitto.conf）の配置場所
C) Retainメッセージなどの永続化データの保存先

**回答**:
- 1 → ____
- 2 → ____
- 3 → ____

---

### 問題4：mosquitto.confの設定（正誤問題）

以下の設定内容について、正しければ○、間違っていれば×を付けてください。

```conf
listener 1883
allow_anonymous true
persistence true
persistence_location /mosquitto/data/
```

1. ポート1883でMQTT接続を待ち受ける（　）
2. 認証なしでの接続が許可される（　）
3. Retainメッセージはブローカーの再起動後に失われる（　）
4. 本番環境でもallow_anonymous trueのままで問題ない（　）

---

### 問題5：コンテナの管理（選択式）

起動中のMQTTブローカーのログをリアルタイムで確認したい場合、どのコマンドを使いますか？

A) `docker ps mqtt-broker`
B) `docker logs mqtt-broker`
C) `docker logs -f mqtt-broker`
D) `docker inspect mqtt-broker`

---

### 問題6：設定ファイルの理解（記述式）

以下の要件を満たすmosquitto.confを作成してください。

**要件**:
- ポート1883でリッスン
- ユーザー名/パスワード認証を必須にする
- パスワードファイルは `/mosquitto/config/passwd`
- 永続化を有効にする
- ログはstdoutとファイル（/mosquitto/log/mosquitto.log）に出力

---

### 問題7：トラブルシューティング（シナリオ問題）

以下のエラーが発生しました。原因と解決方法を説明してください。

**エラーメッセージ**:
```
Error response from daemon: driver failed programming external connectivity:
Bind for 0.0.0.0:1883 failed: port is already allocated
```

**回答欄**:
- 原因: ________________________________________
- 解決方法（2つ挙げてください）:
  1. ________________________________________
  2. ________________________________________

---

### 問題8：ログ設定（選択式）

開発環境でデバッグを行う際、最適なログ設定はどれですか？

A)
```conf
log_dest file /mosquitto/log/mosquitto.log
log_type error
```

B)
```conf
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_type all
log_timestamp true
```

C)
```conf
log_type error
log_type warning
```

D)
```conf
log_dest syslog
log_type information
```

---

### 問題9：セキュリティ（記述式）

学習用設定から本番環境用設定に移行する際、最低限変更すべき設定項目を3つ挙げてください。

1. ________________________________________
2. ________________________________________
3. ________________________________________

---

### 問題10：総合理解（実装問題）

以下の要件を満たすDocker + Mosquittoの環境を構築するコマンドとmosquitto.confを作成してください。

**要件**:
- コンテナ名: `iot-mqtt-broker`
- ホスト側ポート: 1883
- MQTT接続（ポート1883）とWebSocket接続（ポート9001）の両方をサポート
- 認証は不要（学習用）
- 永続化を有効化
- ログはすべて記録し、stdoutとファイルの両方に出力
- 設定、データ、ログは現在のディレクトリの `mqtt/` 配下に保存

**回答欄**:

**1. Dockerコマンド**:
```bash


```

**2. mosquitto.conf**:
```conf


```

---
---

## ✅ 解答と解説

### 問題1の解答

**正解: B**

**理由**:
`-d` オプションは **detached mode（デタッチモード）** の略で、コンテナをバックグラウンドで起動します。このオプションを付けないと、ターミナルがコンテナの出力に占有されてしまいます。

**その他のオプション**:
- A: デバッグモードは存在しません
- C: データディレクトリは `-v` オプションで指定します
- D: 削除可能なのは `--rm` オプションです

**補足**:
`-d` なしで起動すると、Ctrl+Cでコンテナが停止してしまいます。開発中は `-d` を使用してバックグラウンドで起動し、ログは `docker logs` で確認するのが一般的です。

---

### 問題2の解答

**正解**:
- **ホスト名**: `localhost` （または `127.0.0.1`）
- **ポート番号**: `1884`

**理由**:
`-p 1884:1883` は **ホスト側:コンテナ側** のポートマッピングを意味します。
- **1884**: ホスト（あなたのPC）でリッスンするポート
- **1883**: コンテナ内部でMosquittoが使用するポート

**接続例**:
```bash
mosquitto_sub -h localhost -p 1884 -t test/topic
```

```python
client.connect("localhost", 1884, 60)
```

**重要なポイント**:
クライアントから見えるのはホスト側のポート（1884）です。コンテナ内部のポート（1883）は外部から直接アクセスできません。

---

### 問題3の解答

**正解**:
- 1 → **B** （設定ファイルの配置場所）
- 2 → **C** （永続化データの保存先）
- 3 → **A** （ログファイルの保存先）

**詳細説明**:

**1. `/mosquitto/config`**:
- mosquitto.confなどの設定ファイルを配置
- Mosquittoはここから設定を読み込む
- 最も重要なマウントポイント

**2. `/mosquitto/data`**:
- Retainメッセージ、QoS 1/2のメッセージキュー、購読情報を保存
- `persistence true` の場合に使用される
- コンテナを削除しても、Retainメッセージが保持される

**3. `/mosquitto/log`**:
- mosquitto.logなどのログファイルを保存
- トラブルシューティングに便利
- オプショナル（stdoutだけでも動作する）

---

### 問題4の解答

**正解**:
1. ○ **正しい**
2. ○ **正しい**
3. × **間違い**
4. × **間違い**

**解説**:

**1. ポート1883でMQTT接続を待ち受ける**
- ✅ 正しい。`listener 1883` はポート1883でリッスンすることを意味します。

**2. 認証なしでの接続が許可される**
- ✅ 正しい。`allow_anonymous true` により、ユーザー名/パスワードなしで接続できます。

**3. Retainメッセージはブローカーの再起動後に失われる**
- ❌ 間違い。`persistence true` により、Retainメッセージは永続化され、再起動後も保持されます。
- `persistence_location` で指定したディレクトリ（/mosquitto/data/）に保存されます。

**4. 本番環境でもallow_anonymous trueのままで問題ない**
- ❌ 間違い。本番環境では **必ず `allow_anonymous false`** に設定し、認証を有効化してください。
- セキュリティリスク: 誰でも接続してメッセージを送受信できてしまいます。

---

### 問題5の解答

**正解: C**

**理由**:
`docker logs -f mqtt-broker` の `-f` オプションは **follow（追跡）** の略で、ログをリアルタイムで表示します（`tail -f` と同じ動作）。

**各コマンドの違い**:

| コマンド | 動作 |
|:---|:---|
| `docker ps mqtt-broker` | ❌ 構文エラー（`docker ps`にコンテナ名は指定できない） |
| `docker logs mqtt-broker` | △ 過去のログを一度だけ表示して終了 |
| `docker logs -f mqtt-broker` | ✅ ログをリアルタイムで表示（Ctrl+Cで終了） |
| `docker inspect mqtt-broker` | ❌ コンテナの設定情報を表示（ログではない） |

**その他の便利なオプション**:
```bash
# 最新100行だけ表示してからリアルタイム追跡
docker logs -f --tail 100 mqtt-broker

# タイムスタンプ付きで表示
docker logs -f -t mqtt-broker
```

---

### 問題6の解答

**正解例**:
```conf
# ポート1883でリッスン
listener 1883
protocol mqtt

# 認証設定
allow_anonymous false
password_file /mosquitto/config/passwd

# 永続化設定
persistence true
persistence_location /mosquitto/data/

# ログ設定
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_type all
log_timestamp true
```

**採点基準**:
- [ ] `listener 1883` が含まれている
- [ ] `allow_anonymous false` が設定されている
- [ ] `password_file /mosquitto/config/passwd` が設定されている
- [ ] `persistence true` が設定されている
- [ ] `log_dest stdout` と `log_dest file ...` の両方がある

**重要なポイント**:

**認証の有効化**:
```conf
allow_anonymous false        # 匿名接続を拒否
password_file /mosquitto/config/passwd  # パスワードファイルのパス
```

パスワードファイルの作成も必要です：
```bash
docker exec -it mqtt-broker mosquitto_passwd -c /mosquitto/config/passwd admin
# パスワードを入力
```

**ログの出力先**:
- `stdout`: docker logsで確認できる
- `file`: ファイルに保存（長期保存、解析に便利）

---

### 問題7の解答

**原因**:
ポート1883が既に他のプログラムまたは既存のコンテナで使用されている。

**解決方法**:

**1. 既存のコンテナを停止・削除**
```bash
# 同名のコンテナを削除
docker rm -f mqtt-broker

# すべてのmosquittoコンテナを確認して削除
docker ps -a | grep mosquitto
docker rm -f <container_id>
```

**2. ポート1883を使用しているプロセスを確認して終了**
```bash
# Windows
netstat -ano | findstr :1883
# 最後の数字がプロセスID

# タスクマネージャーでプロセスを終了
```

**3. 別のポートを使用**
```bash
# ホスト側のポートを変更
docker run -d --name mqtt-broker -p 1884:1883 eclipse-mosquitto
```

**4. 既存のMosquittoサービスを停止（Windowsでローカルインストールしている場合）**
```bash
# サービスの確認
net stop mosquitto
```

**その他の原因**:
- 以前のコンテナが異常終了してポートが開放されていない
- Windowsのポート予約によってブロックされている

---

### 問題8の解答

**正解: B**

**理由**:
開発環境でデバッグする場合、**詳細なログをすべて記録し、複数の出力先に保存**するのが最適です。

**Bの設定の利点**:
```conf
log_dest stdout                              # docker logsで確認可能
log_dest file /mosquitto/log/mosquitto.log  # ファイルにも保存（検索、解析に便利）
log_type all                                 # すべてのログを記録
log_timestamp true                           # タイムスタンプ付き（問題の時系列把握）
```

**他の選択肢の問題点**:

**A**: エラーのみ → デバッグには情報不足
```conf
log_dest file /mosquitto/log/mosquitto.log
log_type error
```

**C**: ファイル出力なし、エラーと警告のみ → 詳細不足
```conf
log_type error
log_type warning
```

**D**: syslogとinformationのみ → デバッグには不十分
```conf
log_dest syslog
log_type information
```

**環境別の推奨設定**:
- **学習・開発**: `log_type all` + stdout + file
- **本番**: `log_type error warning notice` + file
- **デバッグ**: `log_type all debug subscribe unsubscribe` + stdout + file

---

### 問題9の解答

**正解例**:

**1. 認証の有効化**
```conf
# 変更前
allow_anonymous true

# 変更後
allow_anonymous false
password_file /mosquitto/config/passwd
acl_file /mosquitto/config/acl.conf  # さらに厳格に
```

**2. TLS/SSL暗号化の有効化**
```conf
# 変更前
listener 1883
protocol mqtt

# 変更後
listener 8883
protocol mqtt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key
cafile /mosquitto/certs/ca.crt
require_certificate true
```

**3. ログレベルの調整**
```conf
# 変更前
log_type all

# 変更後
log_type error
log_type warning
log_type notice
```

**その他の重要な変更**:
- **リソース制限**:
  ```conf
  max_connections 10000
  max_queued_messages 1000
  memory_limit 524288000  # 500MB
  ```

- **ファイアウォール設定**: ポート1883を閉じ、8883のみ開放

- **監視とアラート**: システムログ、メトリクス収集

---

### 問題10の解答

**1. Dockerコマンド**:
```bash
docker run -d \
  --name iot-mqtt-broker \
  -p 1883:1883 \
  -p 9001:9001 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  -v "$(pwd)/mqtt/data:/mosquitto/data" \
  -v "$(pwd)/mqtt/log:/mosquitto/log" \
  eclipse-mosquitto
```

**Windows（PowerShell）の場合**:
```powershell
docker run -d `
  --name iot-mqtt-broker `
  -p 1883:1883 `
  -p 9001:9001 `
  -v ${PWD}/mqtt/config:/mosquitto/config `
  -v ${PWD}/mqtt/data:/mosquitto/data `
  -v ${PWD}/mqtt/log:/mosquitto/log `
  eclipse-mosquitto
```

**2. mosquitto.conf**:
```conf
# MQTT接続（ポート1883）
listener 1883
protocol mqtt

# WebSocket接続（ポート9001）
listener 9001
protocol websockets

# アクセス制御（学習用：認証なし）
allow_anonymous true

# 永続化設定
persistence true
persistence_location /mosquitto/data/
autosave_interval 300

# ログ設定
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_type all
log_timestamp true

# 接続設定
max_connections -1
```

**採点基準**:
- [ ] コンテナ名が `iot-mqtt-broker`
- [ ] `-p 1883:1883` と `-p 9001:9001` が両方ある
- [ ] 3つのボリュームマウントが正しい
- [ ] mosquitto.confに2つのリスナー（1883と9001）がある
- [ ] listener 9001に `protocol websockets` が設定されている
- [ ] `allow_anonymous true` が設定されている
- [ ] `persistence true` が設定されている
- [ ] ログが stdout とファイルの両方に出力されている

**動作確認**:
```bash
# MQTT接続
mosquitto_sub -h localhost -p 1883 -t test/topic

# WebSocket接続（ブラウザから）
const client = mqtt.connect('ws://localhost:9001');
```

---

## 🎯 採点基準

- **8問以上正解**: ✅ 優秀！次の章に進めます
- **6〜7問正解**: △ 基本は理解できています。間違えた部分を復習しましょう
- **5問以下**: ⚠️ もう一度、第2章のドキュメントを読み直すことをおすすめします

---

## 📝 よくある間違い

| よくある間違い | 正しい理解 |
|:---|:---|
| `-p 1883:1884` で、1884に接続する | ホスト側（左側）のポートに接続 |
| `persistence true` でもRetainが消える | ボリュームマウントがないとコンテナ削除時に消える |
| `allow_anonymous false` で認証不要 | `false` は認証**必須**の意味 |
| `-d` はデバッグモード | デタッチモード（バックグラウンド実行） |

---

## 🔄 復習のポイント

### Docker関連
- [ ] `-p` オプションのポートマッピング（ホスト:コンテナ）
- [ ] `-v` オプションのボリュームマウント
- [ ] `docker logs -f` でリアルタイムログ確認
- [ ] コンテナの起動・停止・削除コマンド

### mosquitto.conf関連
- [ ] `listener` と `protocol` の設定
- [ ] `allow_anonymous` の本番環境での設定
- [ ] `persistence` と `persistence_location`
- [ ] `log_dest` と `log_type` の組み合わせ

---

**お疲れさまでした！**
この章の内容を理解できたら、次はPythonでMQTTクライアントを実装してみましょう！

**次の章**: [第3章：Pythonクライアントの実装](../step3/python_client_implementation.md)
