# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

## ðŸ”§ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

Docker + Mosquittoã§ç™ºç”Ÿã™ã‚‹ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºæ–¹æ³•ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚
å•é¡ŒãŒç™ºç”Ÿã—ãŸã‚‰ã€ã¾ãšã“ã®ã‚¬ã‚¤ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ðŸ“‹ å•é¡Œã®è¨ºæ–­æ‰‹é †

å•é¡ŒãŒç™ºç”Ÿã—ãŸã‚‰ã€ä»¥ä¸‹ã®é †ç•ªã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### 1. DockerãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª

```bash
docker ps
```

**ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ**: Docker Desktopã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚

### 2. ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª

```bash
docker ps | grep mqtt-broker
```

**ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„å ´åˆ**: ã‚³ãƒ³ãƒ†ãƒŠãŒåœæ­¢ã—ã¦ã„ã¾ã™ã€‚

```bash
# åœæ­¢ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚‚å«ã‚ã¦è¡¨ç¤º
docker ps -a | grep mqtt-broker
```

### 3. ãƒ­ã‚°ã‚’ç¢ºèª

```bash
docker logs mqtt-broker
```

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å•é¡Œã‚’ç‰¹å®šã§ãã¾ã™ã€‚

### 4. ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°æƒ…å ±ã‚’ç¢ºèª

```bash
docker inspect mqtt-broker
```

---

## âŒ ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•

### ã‚¨ãƒ©ãƒ¼1: ãƒãƒ¼ãƒˆãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Error response from daemon: driver failed programming external connectivity on endpoint mqtt-broker:
Bind for 0.0.0.0:1883 failed: port is already allocated
```

#### åŽŸå› 
ãƒãƒ¼ãƒˆ1883ãŒä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¾ãŸã¯æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚

#### è§£æ±ºæ–¹æ³•1: ä½¿ç”¨ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª

**Windows**:
```bash
netstat -ano | findstr :1883
```

**å‡ºåŠ›ä¾‹**:
```
TCP    0.0.0.0:1883           0.0.0.0:0              LISTENING       12345
```

æœ€å¾Œã®æ•°å­—ï¼ˆ12345ï¼‰ãŒãƒ—ãƒ­ã‚»ã‚¹IDã§ã™ã€‚

**ã‚¿ã‚¹ã‚¯ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†**:
1. ã‚¿ã‚¹ã‚¯ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’é–‹ãï¼ˆCtrl+Shift+Escï¼‰
2. è©³ç´°ã‚¿ãƒ–ã§PID 12345ã‚’æ¤œç´¢
3. ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†

#### è§£æ±ºæ–¹æ³•2: æ—¢å­˜ã®MQTTã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤

```bash
# åŒåã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
docker rm -f mqtt-broker

# ã™ã¹ã¦ã®mosquittoã‚³ãƒ³ãƒ†ãƒŠã‚’ç¢ºèª
docker ps -a | grep mosquitto
```

#### è§£æ±ºæ–¹æ³•3: åˆ¥ã®ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨

```bash
# ãƒ›ã‚¹ãƒˆå´ã®ãƒãƒ¼ãƒˆã‚’1884ã«å¤‰æ›´
docker run -d --name mqtt-broker -p 1884:1883 -v "$(pwd)/mqtt/config:/mosquitto/config" eclipse-mosquitto
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæŽ¥ç¶šæ™‚ã¯ `localhost:1884` ã‚’æŒ‡å®šã—ã¾ã™ã€‚

---

### ã‚¨ãƒ©ãƒ¼2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Error: Unable to open config file /mosquitto/config/mosquitto.conf
```

#### åŽŸå› 
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
- ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒžã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãŒé–“é•ã£ã¦ã„ã‚‹

#### è§£æ±ºæ–¹æ³•1: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª

```bash
# ãƒ›ã‚¹ãƒˆå´ã§ç¢ºèª
ls -la mqtt/config/mosquitto.conf

# ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ä½œæˆ
cat > mqtt/config/mosquitto.conf << 'EOF'
listener 1883
allow_anonymous true
persistence true
persistence_location /mosquitto/data/
log_dest stdout
log_type all
EOF
```

#### è§£æ±ºæ–¹æ³•2: ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒžã‚¦ãƒ³ãƒˆãƒ‘ã‚¹ã®ç¢ºèª

```bash
# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
pwd

# çµ¶å¯¾ãƒ‘ã‚¹ã§ãƒžã‚¦ãƒ³ãƒˆï¼ˆæŽ¨å¥¨ï¼‰
docker run -d --name mqtt-broker \
  -p 1883:1883 \
  -v /d/Develop/python/StudyMQTT/mqtt/config:/mosquitto/config \
  eclipse-mosquitto
```

**Windowsï¼ˆPowerShellï¼‰ã®å ´åˆ**:
```powershell
# çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
$currentPath = (Get-Location).Path
echo $currentPath

# ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦èµ·å‹•
docker run -d --name mqtt-broker `
  -p 1883:1883 `
  -v "${currentPath}/mqtt/config:/mosquitto/config" `
  eclipse-mosquitto
```

#### è§£æ±ºæ–¹æ³•3: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å•é¡Œ

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
ls -l mqtt/config/mosquitto.conf

# èª­ã¿å–ã‚Šæ¨©é™ã‚’ä»˜ä¸Ž
chmod 644 mqtt/config/mosquitto.conf

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³
chmod 755 mqtt/config
```

---

### ã‚¨ãƒ©ãƒ¼3: ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã‚‚ã™ãåœæ­¢ã™ã‚‹

#### ç—‡çŠ¶
```bash
docker ps
# â†’ mqtt-brokerãŒè¡¨ç¤ºã•ã‚Œãªã„

docker ps -a
# â†’ STATUS ãŒ "Exited (1) 2 seconds ago" ã«ãªã£ã¦ã„ã‚‹
```

#### åŽŸå› 
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ã€‚

#### è§£æ±ºæ–¹æ³•1: ãƒ­ã‚°ã‚’ç¢ºèª

```bash
docker logs mqtt-broker
```

**ã‚¨ãƒ©ãƒ¼ä¾‹**:
```
Error: Unknown configuration variable "invalid_option"
```

#### è§£æ±ºæ–¹æ³•2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼

**ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã›ãšã«æ¤œè¨¼**:
```bash
docker run --rm \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  eclipse-mosquitto \
  mosquitto -c /mosquitto/config/mosquitto.conf -v
```

**æ­£å¸¸ãªå ´åˆ**:
```
1705305600: mosquitto version 2.0.18 starting
1705305600: Config loaded from /mosquitto/config/mosquitto.conf.
```

#### è§£æ±ºæ–¹æ³•3: æœ€å°é™ã®è¨­å®šã§èµ·å‹•

```bash
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ€å°é™ã«å¤‰æ›´
cat > mqtt/config/mosquitto.conf << 'EOF'
listener 1883
allow_anonymous true
EOF

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¦å†ä½œæˆ
docker rm -f mqtt-broker
docker run -d --name mqtt-broker -p 1883:1883 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  eclipse-mosquitto
```

---

### ã‚¨ãƒ©ãƒ¼4: æŽ¥ç¶šã§ããªã„ï¼ˆConnection Refusedï¼‰

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Error: Connection refused
Unable to connect to localhost:1883
```

#### åŽŸå› ã®åˆ‡ã‚Šåˆ†ã‘

**Step 1: ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹**
```bash
docker ps | grep mqtt-broker
```

èµ·å‹•ã—ã¦ã„ãªã„å ´åˆ â†’ [ã‚¨ãƒ©ãƒ¼3](#ã‚¨ãƒ©ãƒ¼3-ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã‚‚ã™ãåœæ­¢ã™ã‚‹) ã‚’å‚ç…§

**Step 2: ãƒãƒ¼ãƒˆãŒæ­£ã—ããƒžãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‹**
```bash
docker port mqtt-broker
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```
1883/tcp -> 0.0.0.0:1883
```

**Step 3: ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã‹ã‚‰æŽ¥ç¶šã§ãã‚‹ã‹**
```bash
docker exec mqtt-broker mosquitto_sub -h localhost -t test/topic -v
```

æˆåŠŸã™ã‚Œã°ã€ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã¯æ­£å¸¸ã§ã™ã€‚

**Step 4: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ç¢ºèª**

Windowsãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãŒãƒãƒ¼ãƒˆ1883ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# Windows Defenderãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§1883ãƒãƒ¼ãƒˆã‚’è¨±å¯
# PowerShellã‚’ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œ
New-NetFirewallRule -DisplayName "MQTT" -Direction Inbound -LocalPort 1883 -Protocol TCP -Action Allow
```

#### è§£æ±ºæ–¹æ³•: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’å¤‰æ›´

```bash
# ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ï¼ˆLinuxã®ã¿ï¼‰
docker run -d --name mqtt-broker --network host \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  eclipse-mosquitto

# Windowsã®å ´åˆã¯é€šå¸¸ã®ãƒãƒ¼ãƒˆãƒžãƒƒãƒ”ãƒ³ã‚°ã‚’ä½¿ç”¨
docker run -d --name mqtt-broker -p 1883:1883 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  eclipse-mosquitto
```

---

### ã‚¨ãƒ©ãƒ¼5: èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆConnection Refused: not authorizedï¼‰

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Connection Refused: not authorized
```

#### åŽŸå› 
`allow_anonymous false` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€èªè¨¼æƒ…å ±ã‚’æä¾›ã—ã¦ã„ãªã„ã€‚

#### è§£æ±ºæ–¹æ³•1: åŒ¿åæŽ¥ç¶šã‚’è¨±å¯ï¼ˆå­¦ç¿’ç”¨ï¼‰

```conf
# mosquitto.confã‚’ç·¨é›†
allow_anonymous true
```

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•
docker restart mqtt-broker
```

#### è§£æ±ºæ–¹æ³•2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
docker exec -it mqtt-broker sh

# mosquitto_passwdã‚³ãƒžãƒ³ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
mosquitto_passwd -c /mosquitto/config/passwd testuser
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›: testpass

# é€€å‡º
exit
```

**mosquitto.confã«è¿½åŠ **:
```conf
allow_anonymous false
password_file /mosquitto/config/passwd
```

```bash
# å†èµ·å‹•
docker restart mqtt-broker
```

**èªè¨¼ä»˜ãã§æŽ¥ç¶š**:
```bash
mosquitto_sub -h localhost -u testuser -P testpass -t test/topic
```

---

### ã‚¨ãƒ©ãƒ¼6: Permission Deniedï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼ï¼‰

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Error: Permission denied
Unable to write to /mosquitto/data/
```

#### åŽŸå› 
Mosquittoãƒ—ãƒ­ã‚»ã‚¹ï¼ˆUID 1883ï¼‰ãŒãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ›¸ãè¾¼ã‚ãªã„ã€‚

#### è§£æ±ºæ–¹æ³•1: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å¤‰æ›´

```bash
# ãƒ›ã‚¹ãƒˆå´ã§ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®š
chmod -R 777 mqtt/data
chmod -R 777 mqtt/log

# ã¾ãŸã¯ç‰¹å®šã®UIDã«æ‰€æœ‰æ¨©ã‚’å¤‰æ›´
chown -R 1883:1883 mqtt/data
chown -R 1883:1883 mqtt/log
```

#### è§£æ±ºæ–¹æ³•2: rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œï¼ˆéžæŽ¨å¥¨ï¼‰

```bash
docker run -d --name mqtt-broker \
  --user root \
  -p 1883:1883 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  -v "$(pwd)/mqtt/data:/mosquitto/data" \
  -v "$(pwd)/mqtt/log:/mosquitto/log" \
  eclipse-mosquitto
```

âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€rootã§ã®å®Ÿè¡Œã¯æŽ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚

---

### ã‚¨ãƒ©ãƒ¼7: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå—ä¿¡ã§ããªã„

#### ç—‡çŠ¶
- Publishã¯æˆåŠŸã™ã‚‹
- Subscribeã—ã¦ã‚‚ä½•ã‚‚å—ä¿¡ã—ãªã„

#### åŽŸå› ã¨è§£æ±ºæ–¹æ³•

**åŽŸå› 1: ãƒˆãƒ”ãƒƒã‚¯åã®ä¸ä¸€è‡´**

```bash
# Publish
mosquitto_pub -t sensor/temperature -m "25.5"

# Subscribeï¼ˆtypoï¼‰
mosquitto_sub -t sensor/temparature
# â†’ ä½•ã‚‚å—ä¿¡ã—ãªã„
```

**è§£æ±º**: ãƒˆãƒ”ãƒƒã‚¯åã‚’æ­£ç¢ºã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**åŽŸå› 2: QoSã¨Retainã®å•é¡Œ**

```bash
# Retainãªã—ã§Publish
mosquitto_pub -t test/topic -m "Hello" -q 0

# ãã®å¾Œã«Subscribe
mosquitto_sub -t test/topic
# â†’ éŽåŽ»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å—ä¿¡ã§ããªã„
```

**è§£æ±º**: Retain=trueã§é€ä¿¡ã™ã‚‹ã‹ã€Subscribeå¾Œã«Publishã—ã¦ãã ã•ã„ã€‚

```bash
# Retainä»˜ãã§Publish
mosquitto_pub -t test/topic -m "Hello" -r -q 1

# å¾Œã‹ã‚‰Subscribeã—ã¦ã‚‚å—ä¿¡ã§ãã‚‹
mosquitto_sub -t test/topic
```

**åŽŸå› 3: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®é–“é•ã„**

```bash
# Publish
mosquitto_pub -t home/livingroom/temperature -m "22"

# é–“é•ã£ãŸãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
mosquitto_sub -t home/+/+/temperature
# â†’ ãƒžãƒƒãƒã—ãªã„ï¼ˆéšŽå±¤ãŒ1ã¤å¤šã„ï¼‰

# æ­£ã—ã„ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
mosquitto_sub -t home/+/temperature
# ã¾ãŸã¯
mosquitto_sub -t home/#
```

---

### ã‚¨ãƒ©ãƒ¼8: Docker Volumeã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹

#### ç—‡çŠ¶
ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦æ¶ˆãˆã‚‹ã€‚

#### åŽŸå› 
ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒžã‚¦ãƒ³ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„ã€‚

#### è§£æ±ºæ–¹æ³•: Named Volumeã‚’ä½¿ç”¨

```bash
# Named Volumeã‚’ä½œæˆ
docker volume create mqtt-data
docker volume create mqtt-logs

# Named Volumeã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker run -d --name mqtt-broker \
  -p 1883:1883 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  -v mqtt-data:/mosquitto/data \
  -v mqtt-logs:/mosquitto/log \
  eclipse-mosquitto
```

**ç¢ºèª**:
```bash
# Volumeã®å ´æ‰€ã‚’ç¢ºèª
docker volume inspect mqtt-data
```

**ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**:
```bash
# Volumeã®å†…å®¹ã‚’tarã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ä¿å­˜
docker run --rm \
  -v mqtt-data:/data \
  -v "$(pwd):/backup" \
  ubuntu tar czf /backup/mqtt-data-backup.tar.gz -C /data .
```

---

## ðŸ” ãƒ‡ãƒãƒƒã‚°æ‰‹æ³•

### 1. è©³ç´°ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–

```conf
# mosquitto.confã«è¿½åŠ 
log_type all
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_timestamp true
```

```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ­ã‚°ã‚’ç›£è¦–
docker logs -f mqtt-broker
```

### 2. ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã‚‹
docker exec -it mqtt-broker sh

# Subscribeï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼‰
mosquitto_sub -h localhost -t test/# -v

# Publish
mosquitto_pub -h localhost -t test/debug -m "test message"

# æˆåŠŸã™ã‚Œã°ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¯æ­£å¸¸
```

### 3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ç¢ºèª

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª
docker inspect mqtt-broker | grep IPAddress

# ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«æŽ¥ç¶š
mosquitto_sub -h 172.17.0.2 -t test/topic
```

### 4. è¨­å®šã®ç¢ºèª

```bash
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤º
docker exec mqtt-broker cat /mosquitto/config/mosquitto.conf

# è¨­å®šãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
docker exec mqtt-broker mosquitto -c /mosquitto/config/mosquitto.conf -v
```

---

## ðŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å•é¡Œ

### å•é¡Œ: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…å»¶

#### åŽŸå› ã¨è§£æ±º

**åŽŸå› 1: QoS 2ã®ä½¿ç”¨**
â†’ QoS 1ã¾ãŸã¯QoS 0ã«å¤‰æ›´

**åŽŸå› 2: ãƒ­ã‚°ãŒå¤§é‡ã«å‡ºåŠ›**
â†’ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’èª¿æ•´

```conf
# ä¸è¦ãªãƒ­ã‚°ã‚’ç„¡åŠ¹åŒ–
log_type error
log_type warning
```

**åŽŸå› 3: ãƒ‡ã‚£ã‚¹ã‚¯I/O**
â†’ autosave_intervalã‚’èª¿æ•´

```conf
# è‡ªå‹•ä¿å­˜é–“éš”ã‚’å»¶é•·
autosave_interval 600  # 10åˆ†
```

### å•é¡Œ: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„

#### è§£æ±ºæ–¹æ³•

```conf
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚’åˆ¶é™
max_queued_messages 100

# ãƒ¡ãƒ¢ãƒªåˆ¶é™
memory_limit 104857600  # 100MB
```

---

## ðŸ†˜ ç·Šæ€¥æ™‚ã®å¯¾å‡¦

### ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™

```bash
# 1. ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
docker rm -f mqtt-broker

# 2. ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ï¼ï¼‰
docker volume rm mqtt-data mqtt-logs

# 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
rm -rf mqtt/data/* mqtt/log/*

# 4. æœ€å°é™ã®è¨­å®šã§å†èµ·å‹•
cat > mqtt/config/mosquitto.conf << 'EOF'
listener 1883
allow_anonymous true
persistence true
persistence_location /mosquitto/data/
log_dest stdout
log_type all
EOF

# 5. ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker run -d --name mqtt-broker \
  -p 1883:1883 \
  -v "$(pwd)/mqtt/config:/mosquitto/config" \
  -v "$(pwd)/mqtt/data:/mosquitto/data" \
  -v "$(pwd)/mqtt/log:/mosquitto/log" \
  eclipse-mosquitto

# 6. ãƒ­ã‚°ã§ç¢ºèª
docker logs mqtt-broker
```

---

## ðŸ“š å‚è€ƒè³‡æ–™

- [Mosquittoå…¬å¼FAQ](https://mosquitto.org/documentation/faq/)
- [Dockerå…¬å¼ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](https://docs.docker.com/config/containers/logging/)
- [MQTT.orgãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰](https://mqtt.org/getting-started/)

---

## ðŸ’¡ å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆ

1. **Mosquittoã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª**
   ```bash
   docker exec mqtt-broker mosquitto -h
   ```

2. **æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã«æ›´æ–°**
   ```bash
   docker pull eclipse-mosquitto:latest
   docker rm -f mqtt-broker
   # å†åº¦èµ·å‹•
   ```

3. **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«è³ªå•**
   - [Mosquitto GitHub Issues](https://github.com/eclipse/mosquitto/issues)
   - [Stack Overflow - MQTT tag](https://stackoverflow.com/questions/tagged/mqtt)
   - [MQTT Community Forum](https://mqtt.org/community/)

---

**å‰ã®ç« **: [ç¬¬2ç« ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](./01_Dockerãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼æ§‹ç¯‰.md)
