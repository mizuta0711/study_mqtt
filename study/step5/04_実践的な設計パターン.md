# å®Ÿè·µçš„ãªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

## ğŸ¯ ã“ã®ç« ã®å†…å®¹

å®Ÿç”¨çš„ãªIoTã‚·ã‚¹ãƒ†ãƒ ã‚’è¨­è¨ˆã™ã‚‹éš›ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã³ã¾ã™ã€‚

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. åŸºæœ¬çš„ãªæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sensors   â”‚ (è¤‡æ•°ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒã‚¤ã‚¹)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Publish (QoS 0/1)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Broker   â”‚ (Mosquitto)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Subscribe
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribers â”‚ (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ãƒ­ã‚¬ãƒ¼ç­‰)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. éšå±¤åŒ–ã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯è¨­è¨ˆ

```
devices/
  â”œâ”€ living-room/
  â”‚   â”œâ”€ sensors/
  â”‚   â”‚   â”œâ”€ temperature
  â”‚   â”‚   â”œâ”€ humidity
  â”‚   â”‚   â””â”€ light
  â”‚   â””â”€ status/
  â”‚       â”œâ”€ online
  â”‚       â””â”€ battery
  â”œâ”€ bedroom/
  â”‚   â””â”€ sensors/
  â”‚       â””â”€ temperature
  â””â”€ kitchen/
      â””â”€ sensors/
          â””â”€ temperature

alerts/
  â”œâ”€ high-temperature
  â”œâ”€ low-battery
  â””â”€ device-offline

logs/
  â””â”€ system
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§æŸ”è»Ÿãªè³¼èª­ãŒå¯èƒ½
- æ¨©é™ç®¡ç†ãŒå®¹æ˜“
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«

---

## ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å‡¦ç†

```python
import paho.mqtt.client as mqtt
import time

def on_connect(client, userdata, flags, rc):
    """æ¥ç¶šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    if rc == 0:
        print("âœ… æ¥ç¶šæˆåŠŸ")
        # è³¼èª­ã‚’å†é–‹
        client.subscribe("sensors/#")
    else:
        error_messages = {
            1: "ä¸æ­£ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³",
            2: "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDæ‹’å¦",
            3: "ã‚µãƒ¼ãƒãƒ¼åˆ©ç”¨ä¸å¯",
            4: "ä¸æ­£ãªãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
            5: "èªè¨¼ã‚¨ãƒ©ãƒ¼"
        }
        print(f"âŒ æ¥ç¶šå¤±æ•—: {error_messages.get(rc, f'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼({rc})')}")

def on_disconnect(client, userdata, rc):
    """åˆ‡æ–­ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    if rc != 0:
        print(f"âš ï¸  äºˆæœŸã—ãªã„åˆ‡æ–­: {rc}")
        print("å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...")
        reconnect(client)

def reconnect(client, max_retries=5):
    """å†æ¥ç¶šå‡¦ç†"""
    for i in range(max_retries):
        try:
            print(f"å†æ¥ç¶šè©¦è¡Œ {i+1}/{max_retries}...")
            client.reconnect()
            return True
        except Exception as e:
            print(f"å¤±æ•—: {e}")
            time.sleep(2 ** i)  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
    return False

client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
client.on_connect = on_connect
client.on_disconnect = on_disconnect
```

### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œè¨¼

```python
import json
from jsonschema import validate, ValidationError

# ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
TEMPERATURE_SCHEMA = {
    "type": "object",
    "properties": {
        "sensor_id": {"type": "string"},
        "value": {"type": "number", "minimum": -50, "maximum": 100},
        "unit": {"type": "string", "enum": ["C", "F"]},
        "timestamp": {"type": "string"}
    },
    "required": ["sensor_id", "value", "timestamp"]
}

def on_message(client, userdata, msg):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®æ¤œè¨¼"""
    try:
        # JSONãƒ‘ãƒ¼ã‚¹
        data = json.loads(msg.payload.decode())

        # ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
        validate(instance=data, schema=TEMPERATURE_SCHEMA)

        # å‡¦ç†
        process_temperature_data(data)

    except json.JSONDecodeError:
        print(f"âš ï¸  ä¸æ­£ãªJSON: {msg.payload}")
    except ValidationError as e:
        print(f"âš ï¸  ã‚¹ã‚­ãƒ¼ãƒã‚¨ãƒ©ãƒ¼: {e.message}")
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
```

---

## ğŸ”„ å†æ¥ç¶šã¨ãƒªã‚«ãƒãƒªãƒ¼

### è‡ªå‹•å†æ¥ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³

```python
class MQTTClient:
    def __init__(self, broker, port):
        self.broker = broker
        self.port = port
        self.client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
        self.client.on_connect = self._on_connect
        self.client.on_disconnect = self._on_disconnect
        self.connected = False

    def _on_connect(self, client, userdata, flags, rc):
        if rc == 0:
            self.connected = True
            print("âœ… æ¥ç¶šæˆåŠŸ")
            # è³¼èª­ã‚’å¾©å…ƒ
            self._resubscribe()
        else:
            self.connected = False
            print(f"âŒ æ¥ç¶šå¤±æ•—: {rc}")

    def _on_disconnect(self, client, userdata, rc):
        self.connected = False
        if rc != 0:
            print("âš ï¸  åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šä¸­...")
            self._reconnect()

    def _reconnect(self):
        """å†æ¥ç¶šå‡¦ç†"""
        while not self.connected:
            try:
                print("å†æ¥ç¶šè©¦è¡Œä¸­...")
                self.client.reconnect()
                time.sleep(5)
            except Exception as e:
                print(f"å†æ¥ç¶šå¤±æ•—: {e}")
                time.sleep(5)

    def _resubscribe(self):
        """è³¼èª­ã‚’å¾©å…ƒ"""
        # ä¿å­˜ã—ã¦ãŠã„ãŸãƒˆãƒ”ãƒƒã‚¯ã‚’å†è³¼èª­
        for topic, qos in self.subscriptions.items():
            self.client.subscribe(topic, qos)
            print(f"ğŸ“¥ å†è³¼èª­: {topic}")

    def connect(self):
        """åˆå›æ¥ç¶š"""
        try:
            self.client.connect(self.broker, self.port, 60)
            self.client.loop_start()
        except Exception as e:
            print(f"æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
            return False
        return True
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

### 1. SQLiteã¸ã®ä¿å­˜

```python
import sqlite3
from datetime import datetime

class DataLogger:
    def __init__(self, db_path='sensor_data.db'):
        self.conn = sqlite3.connect(db_path)
        self._create_tables()

    def _create_tables(self):
        """ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ"""
        cursor = self.conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS sensor_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                sensor_id TEXT NOT NULL,
                timestamp TEXT NOT NULL,
                data_type TEXT NOT NULL,
                value REAL NOT NULL
            )
        ''')
        self.conn.commit()

    def log(self, sensor_id, data_type, value):
        """ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²"""
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO sensor_data (sensor_id, timestamp, data_type, value)
            VALUES (?, ?, ?, ?)
        ''', (sensor_id, datetime.now().isoformat(), data_type, value))
        self.conn.commit()

    def query(self, sensor_id, start_time, end_time):
        """ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT timestamp, data_type, value
            FROM sensor_data
            WHERE sensor_id = ? AND timestamp BETWEEN ? AND ?
            ORDER BY timestamp
        ''', (sensor_id, start_time, end_time))
        return cursor.fetchall()

# ä½¿ç”¨ä¾‹
logger = DataLogger()

def on_message(client, userdata, msg):
    if msg.topic == "sensor/temperature":
        temp = float(msg.payload.decode())
        logger.log("sensor01", "temperature", temp)
```

### 2. CSVãƒ­ã‚°

```python
import csv
from pathlib import Path

class CSVLogger:
    def __init__(self, log_dir='logs'):
        self.log_dir = Path(log_dir)
        self.log_dir.mkdir(exist_ok=True)

    def log(self, sensor_id, data_type, value):
        """CSVãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜"""
        filename = self.log_dir / f"{sensor_id}_{data_type}.csv"

        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›¸ã
        write_header = not filename.exists()

        with open(filename, 'a', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            if write_header:
                writer.writerow(['timestamp', 'value'])
            writer.writerow([datetime.now().isoformat(), value])
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼

```python
client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
client.username_pw_set("username", "password")
client.connect("localhost", 1883, 60)
```

### 2. TLS/SSLæš—å·åŒ–

```python
import ssl

client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)

# TLSè¨­å®š
client.tls_set(
    ca_certs="ca.crt",  # CAè¨¼æ˜æ›¸
    certfile="client.crt",  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸
    keyfile="client.key",  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéµ
    tls_version=ssl.PROTOCOL_TLSv1_2
)

# ãƒãƒ¼ãƒˆ8883ã‚’ä½¿ç”¨ï¼ˆTLSç”¨ï¼‰
client.connect("localhost", 8883, 60)
```

---

## ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### 1. è² è·åˆ†æ•£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sensor1 â”‚     â”‚ Sensor2 â”‚ ... â”‚ SensorN â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  MQTT Broker     â”‚
          â”‚  (Load Balanced) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚Dashboardâ”‚     â”‚ Logger  â”‚    â”‚Analyticsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å…±æœ‰è³¼èª­ï¼ˆShared Subscriptionsï¼‰

```python
# MQTT 5.0ä»¥é™
client.subscribe("$share/group1/sensors/#")
```

è¤‡æ•°ã®Subscriberã§è² è·ã‚’åˆ†æ•£ã§ãã¾ã™ã€‚

---

## ğŸ¯ QoSã¨Retainã®æˆ¦ç•¥

### ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã”ã¨ã®è¨­å®š

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | QoS | Retain | ç†ç”± |
|:---|:---:|:---:|:---|
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ | 0 | âŒ | é«˜é€Ÿæ€§é‡è¦–ã€æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã™ãæ¥ã‚‹ |
| ãƒ‡ãƒã‚¤ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 1 | âœ… | ç¢ºå®Ÿã«å±Šã‘ã€æ–°è¦Subscriberã‚‚å³åº§ã«çŠ¶æ…‹æŠŠæ¡ |
| ã‚¢ãƒ©ãƒ¼ãƒˆ | 2 | âŒ | çµ¶å¯¾ã«å¤±ã£ã¦ã¯ã„ã‘ãªã„ã€é‡è¤‡ã‚‚é¿ã‘ã‚‹ |
| è¨­å®šã‚³ãƒãƒ³ãƒ‰ | 2 | âœ… | ç¢ºå®Ÿã«å±Šã‘ã€ãƒ‡ãƒã‚¤ã‚¹å†èµ·å‹•æ™‚ã‚‚é©ç”¨ |

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ

```python
import unittest
from unittest.mock import Mock, patch

class TestSensorPublisher(unittest.TestCase):
    def test_temperature_generation(self):
        """æ¸©åº¦ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ"""
        sensor = TemperatureSensor()
        temp = sensor.generate_temperature()
        self.assertGreaterEqual(temp, 15.0)
        self.assertLessEqual(temp, 35.0)

    @patch('paho.mqtt.client.Client')
    def test_publish(self, mock_client):
        """Publishæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        sensor = TemperatureSensor(mock_client)
        sensor.publish_temperature(25.5)
        mock_client.publish.assert_called_once()
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨
mosquitto -v -p 1883

# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
python tests/integration_test.py
```

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°

### æ§‹é€ åŒ–ãƒ­ã‚°

```python
import logging
import json

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('mqtt_system.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def on_message(client, userdata, msg):
    """æ§‹é€ åŒ–ãƒ­ã‚°ã®å‡ºåŠ›"""
    log_data = {
        "event": "message_received",
        "topic": msg.topic,
        "payload_size": len(msg.payload),
        "qos": msg.qos,
        "retain": msg.retain
    }
    logger.info(json.dumps(log_data))
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

- [ ] é©åˆ‡ãªãƒˆãƒ”ãƒƒã‚¯éšå±¤ã‚’è¨­è¨ˆã§ãã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] è‡ªå‹•å†æ¥ç¶šæ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã§ãã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã§ãã‚‹
- [ ] ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã§ãã‚‹

---

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- [01_IoTã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰å®Ÿè·µ.md](./01_IoTã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰å®Ÿè·µ.md) - åŸºæœ¬å®Ÿè£…
- [05_å¿œç”¨ã‚³ãƒ¼ãƒ‰é›†.md](./05_å¿œç”¨ã‚³ãƒ¼ãƒ‰é›†.md) - å®Ÿè£…ä¾‹
