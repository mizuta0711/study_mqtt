# ã‚»ãƒ³ã‚µãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°

## ğŸ¯ ã“ã®ç« ã®å†…å®¹

ã‚ˆã‚Šæœ¬æ ¼çš„ãªã‚»ãƒ³ã‚µãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚

---

## ğŸŒ¡ï¸ ãƒªã‚¢ãƒ«ãªã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ

### 1. åŸºæœ¬çš„ãªãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿

```python
import random

# å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ20.0ã€œ30.0Â°Cï¼‰
temperature = round(random.uniform(20.0, 30.0), 2)
```

**å•é¡Œç‚¹**: æ¸©åº¦ãŒæ€¥æ¿€ã«å¤‰åŒ–ã—ã™ãã¦éç¾å®Ÿçš„

---

### 2. å‰å›å€¤ã‹ã‚‰ã®å¤‰åŒ–é‡ã‚’åˆ¶é™

ã‚ˆã‚Šç¾å®Ÿçš„ãªæ¸©åº¦å¤‰åŒ–ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€å‰å›ã®æ¸©åº¦ã‹ã‚‰ã®å¤‰åŒ–é‡ã‚’åˆ¶é™ã—ã¾ã™ã€‚

```python
import random

current_temp = 25.0  # åˆæœŸæ¸©åº¦

while True:
    # å‰å›ã‹ã‚‰Â±0.5Â°Cã®ç¯„å›²ã§å¤‰åŒ–
    change = random.uniform(-0.5, 0.5)
    current_temp += change

    # ç¯„å›²åˆ¶é™ï¼ˆ15ã€œ35Â°Cï¼‰
    current_temp = max(15.0, min(35.0, current_temp))

    print(f"æ¸©åº¦: {current_temp:.2f}Â°C")
    time.sleep(1)
```

**çµæœ**: ãªã‚ã‚‰ã‹ãªæ¸©åº¦å¤‰åŒ–

---

### 3. æ™‚åˆ»ã«å¿œã˜ãŸå¤‰åŒ–ï¼ˆæ—¥å†…å¤‰å‹•ï¼‰

å®Ÿéš›ã®æ¸©åº¦ã¯æ™‚åˆ»ã«ã‚ˆã£ã¦å¤‰åŒ–ã—ã¾ã™ã€‚

```python
import math
from datetime import datetime

def get_base_temperature():
    """æ™‚åˆ»ã«å¿œã˜ãŸåŸºæº–æ¸©åº¦ã‚’è¨ˆç®—"""
    hour = datetime.now().hour

    # æ­£å¼¦æ³¢ã§æ—¥å†…å¤‰å‹•ã‚’è¡¨ç¾
    # 0æ™‚: 20Â°C, 12æ™‚: 28Â°C
    base = 24.0 + 4.0 * math.sin(math.pi * (hour - 6) / 12)

    return base

current_temp = get_base_temperature()

while True:
    base = get_base_temperature()

    # åŸºæº–æ¸©åº¦ã«è¿‘ã¥ã + ãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚¤ã‚º
    current_temp += (base - current_temp) * 0.1 + random.uniform(-0.3, 0.3)

    print(f"[{datetime.now().strftime('%H:%M')}] {current_temp:.2f}Â°C")
    time.sleep(1)
```

---

## ğŸ”§ è¤‡æ•°ã‚»ãƒ³ã‚µãƒ¼ã®ç®¡ç†

### è¤‡æ•°ã®ã‚»ãƒ³ã‚µãƒ¼ã‚’åŒæ™‚ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

**ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«**: [../../mqtt_clients/step5/multi_sensor_publisher.py](../../mqtt_clients/step5/multi_sensor_publisher.py)

```python
# è¤‡æ•°ã‚»ãƒ³ã‚µãƒ¼ã®ä¾‹
sensors = [
    {"id": "sensor01", "location": "ãƒªãƒ“ãƒ³ã‚°"},
    {"id": "sensor02", "location": "å¯å®¤"},
    {"id": "sensor03", "location": "ã‚­ãƒƒãƒãƒ³"}
]

for sensor in sensors:
    topic = f"sensors/{sensor['id']}/temperature"
    client.publish(topic, temperature, qos=0)
```

**ãƒˆãƒ”ãƒƒã‚¯è¨­è¨ˆ:**
```
sensors/sensor01/temperature
sensors/sensor01/humidity
sensors/sensor01/status

sensors/sensor02/temperature
sensors/sensor02/humidity
sensors/sensor02/status
```

---

## ğŸ“Š æ§˜ã€…ãªã‚»ãƒ³ã‚µãƒ¼ã‚¿ã‚¤ãƒ—

### æ¸©åº¦ä»¥å¤–ã®ã‚»ãƒ³ã‚µãƒ¼

```python
# æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ï¼ˆ30ã€œ70%ï¼‰
humidity = round(random.uniform(30.0, 70.0), 1)
client.publish("sensors/humidity", humidity, qos=0)

# ç…§åº¦ã‚»ãƒ³ã‚µãƒ¼ï¼ˆ0ã€œ1000 luxï¼‰
light = int(random.uniform(0, 1000))
client.publish("sensors/light", light, qos=0)

# ãƒ‰ã‚¢ã‚»ãƒ³ã‚µãƒ¼ï¼ˆé–‹/é–‰ï¼‰
door_status = random.choice(["OPEN", "CLOSED"])
client.publish("sensors/door", door_status, qos=1, retain=True)

# äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼ï¼ˆæ¤œçŸ¥/éæ¤œçŸ¥ï¼‰
motion = random.choice([True, False])
client.publish("sensors/motion", str(motion), qos=0)
```

---

## ğŸš¨ ç•°å¸¸å€¤ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### ç•°å¸¸å€¤ã®æ¤œå‡ºã¨é€ä¿¡

```python
# æ¸©åº¦ã®ç•°å¸¸å€¤ã‚’æ¤œå‡º
if temperature > 30.0 or temperature < 18.0:
    alert_message = {
        "sensor_id": SENSOR_ID,
        "type": "temperature",
        "value": temperature,
        "threshold": "18-30Â°C",
        "timestamp": datetime.now().isoformat()
    }

    # ã‚¢ãƒ©ãƒ¼ãƒˆã¯QoS 2ã§ç¢ºå®Ÿã«é€ä¿¡
    client.publish(
        "alerts/temperature",
        json.dumps(alert_message),
        qos=2
    )
    print(f"ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡: {temperature}Â°C")
```

---

## ğŸ”Œ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å†æ¥ç¶š

### æ¥ç¶šã‚¨ãƒ©ãƒ¼ã¸ã®å¯¾å¿œ

```python
import time

def connect_with_retry(client, broker, port, max_retries=5):
    """ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãæ¥ç¶š"""
    for attempt in range(max_retries):
        try:
            print(f"æ¥ç¶šè©¦è¡Œ {attempt + 1}/{max_retries}...")
            client.connect(broker, port, 60)
            print("âœ… æ¥ç¶šæˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ æ¥ç¶šå¤±æ•—: {e}")
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                print(f"â³ {wait_time}ç§’å¾Œã«å†è©¦è¡Œ...")
                time.sleep(wait_time)

    return False

# ä½¿ç”¨ä¾‹
if connect_with_retry(client, BROKER, PORT):
    client.loop_start()
else:
    print("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ")
    sys.exit(1)
```

---

## ğŸ“ ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ã‚®ãƒ³ã‚°

### ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜

```python
import csv
from datetime import datetime

def log_to_csv(sensor_id, temperature):
    """CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²"""
    with open(f'logs/{sensor_id}_log.csv', 'a', newline='') as f:
        writer = csv.writer(f)
        writer.writerow([
            datetime.now().isoformat(),
            temperature
        ])

# ä½¿ç”¨ä¾‹
log_to_csv(SENSOR_ID, temperature)
```

---

## ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ´»ç”¨

### config.jsonã§ã‚»ãƒ³ã‚µãƒ¼è¨­å®šã‚’ç®¡ç†

```json
{
  "broker": "localhost",
  "port": 1883,
  "sensors": [
    {
      "id": "sensor01",
      "type": "temperature",
      "location": "ãƒªãƒ“ãƒ³ã‚°",
      "min": 18.0,
      "max": 30.0,
      "interval": 1
    },
    {
      "id": "sensor02",
      "type": "humidity",
      "location": "å¯å®¤",
      "min": 30.0,
      "max": 70.0,
      "interval": 2
    }
  ]
}
```

```python
import json

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
with open('config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)

BROKER = config['broker']
PORT = config['port']
sensors = config['sensors']
```

---

## ğŸ¨ å®Ÿè£…ä¾‹

### é«˜åº¦ãªã‚»ãƒ³ã‚µãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼

**ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«**: [../../mqtt_clients/step5/advanced_sensor_publisher.py](../../mqtt_clients/step5/advanced_sensor_publisher.py)

ä¸»ãªæ©Ÿèƒ½ï¼š
- âœ… ãƒªã‚¢ãƒ«ãªæ¸©åº¦å¤‰åŒ–ï¼ˆå‰å›å€¤ã‹ã‚‰ã®å¤‰åŒ–é‡åˆ¶é™ï¼‰
- âœ… æ™‚åˆ»ã«å¿œã˜ãŸåŸºæº–æ¸©åº¦ã®å¤‰å‹•
- âœ… ç•°å¸¸å€¤ã®æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
- âœ… æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
- âœ… CSVãƒ­ã‚°æ©Ÿèƒ½

---

## ğŸ’¡ è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

### 1. QoSã®ä½¿ã„åˆ†ã‘

| ãƒ‡ãƒ¼ã‚¿ç¨®é¡ | QoS | ç†ç”± |
|:---|:---:|:---|
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆæ¸©åº¦ç­‰ï¼‰ | 0 | é«˜é€Ÿæ€§é‡è¦–ã€æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã™ãæ¥ã‚‹ |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 1 | ç¢ºå®Ÿã«å±Šã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ |
| ã‚¢ãƒ©ãƒ¼ãƒˆ | 2 | çµ¶å¯¾ã«å¤±ã£ã¦ã¯ã„ã‘ãªã„ |

### 2. Retainã®ä½¿ã„æ–¹

```python
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯Retainæœ‰åŠ¹
client.publish("sensor/status", "ONLINE", retain=True)

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã¯Retainä¸è¦
client.publish("sensor/temperature", temp, retain=False)
```

### 3. ãƒˆãƒ”ãƒƒã‚¯éšå±¤ã®è¨­è¨ˆ

```
sensors/
  â”œâ”€ sensor01/
  â”‚   â”œâ”€ temperature
  â”‚   â”œâ”€ humidity
  â”‚   â””â”€ status
  â”œâ”€ sensor02/
  â”‚   â”œâ”€ temperature
  â”‚   â””â”€ status
  â””â”€ ...
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ

```bash
# ã‚»ãƒ³ã‚µãƒ¼å˜ç‹¬ã§èµ·å‹•
python mqtt_clients/step5/sensor_publisher.py
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
python mqtt_clients/step5/dashboard_subscriber.py

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: ã‚»ãƒ³ã‚µãƒ¼
python mqtt_clients/step5/sensor_publisher.py

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3: MQTT Explorerï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# ãƒˆãƒ”ãƒƒã‚¯ã®æµã‚Œã‚’è¦–è¦šçš„ã«ç¢ºèª
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

- [ ] ãªã‚ã‚‰ã‹ãªæ¸©åº¦å¤‰åŒ–ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] è¤‡æ•°ã‚»ãƒ³ã‚µãƒ¼ã‚’ç®¡ç†ã§ãã‚‹
- [ ] ç•°å¸¸å€¤ã‚’æ¤œå‡ºã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã§ãã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã§ãã‚‹

---

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- [01_IoTã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰å®Ÿè·µ.md](./01_IoTã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰å®Ÿè·µ.md) - åŸºæœ¬å®Ÿè£…
- [05_å¿œç”¨ã‚³ãƒ¼ãƒ‰é›†.md](./05_å¿œç”¨ã‚³ãƒ¼ãƒ‰é›†.md) - å®Ÿè£…ä¾‹
